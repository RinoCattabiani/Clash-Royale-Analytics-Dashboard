<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clash Royale Player Analysis Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #060d15;
    --bg-primary: #0b1622;
    --bg-card: #101e2e;
    --bg-card-hover: #152738;
    --border: #1a3048;
    --border-glow: #00e5ff33;
    --accent-cyan: #00e5ff;
    --accent-gold: #ffd740;
    --accent-green: #00e676;
    --accent-red: #ff1744;
    --accent-purple: #b388ff;
    --accent-orange: #ff9100;
    --text-primary: #e8edf3;
    --text-secondary: #7a8fa6;
    --text-muted: #4a5f76;
    --gradient-cyan: linear-gradient(135deg, #00e5ff, #0091ea);
    --gradient-gold: linear-gradient(135deg, #ffd740, #ff9100);
    --gradient-green: linear-gradient(135deg, #00e676, #00c853);
    --gradient-red: linear-gradient(135deg, #ff1744, #d50000);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg-deep);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
      radial-gradient(ellipse at 20% 50%, #00e5ff08 0%, transparent 50%),
      radial-gradient(ellipse at 80% 20%, #b388ff06 0%, transparent 50%),
      radial-gradient(ellipse at 50% 80%, #ffd74005 0%, transparent 50%);
    z-index: 0;
    pointer-events: none;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 40px;
    padding: 40px 24px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 20px;
    position: relative;
    overflow: hidden;
  }

  .header::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--accent-cyan), var(--accent-gold), var(--accent-purple), transparent);
  }

  .header h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: 2.8rem;
    font-weight: 900;
    letter-spacing: 3px;
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 8px;
  }

  .header .subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    letter-spacing: 4px;
    text-transform: uppercase;
  }

  .header .player-tag {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-cyan);
    font-size: 0.95rem;
    margin-top: 8px;
    opacity: 0.7;
  }

  /* Data input area */
  .input-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 32px;
  }

  .input-section h2 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.2rem;
    color: var(--accent-cyan);
    margin-bottom: 16px;
    letter-spacing: 1px;
  }

  .input-section textarea {
    width: 100%;
    height: 140px;
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    padding: 16px;
    resize: vertical;
    transition: border-color 0.3s;
  }

  .input-section textarea:focus {
    outline: none;
    border-color: var(--accent-cyan);
    box-shadow: 0 0 20px #00e5ff15;
  }

  .btn {
    display: inline-block;
    margin-top: 14px;
    padding: 12px 32px;
    background: var(--gradient-cyan);
    border: none;
    border-radius: 10px;
    color: var(--bg-deep);
    font-family: 'Orbitron', sans-serif;
    font-size: 0.95rem;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px #00e5ff30;
  }

  .btn-secondary {
    background: transparent;
    border: 1px solid var(--accent-cyan);
    color: var(--accent-cyan);
    margin-left: 12px;
  }

  /* Dashboard grid */
  .dashboard {
    display: none;
  }

  .dashboard.active {
    display: block;
  }

  .grid {
    display: grid;
    gap: 20px;
    margin-bottom: 28px;
  }

  .grid-4 { grid-template-columns: repeat(4, 1fr); }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .grid-2 { grid-template-columns: repeat(2, 1fr); }

  @media (max-width: 900px) {
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(2, 1fr); }
    .grid-2 { grid-template-columns: 1fr; }
  }

  /* Stat cards */
  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 22px;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .stat-card:hover {
    background: var(--bg-card-hover);
    border-color: var(--border-glow);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0, 229, 255, 0.07);
  }

  .stat-card .label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 2px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .stat-card .value {
    font-family: 'Orbitron', sans-serif;
    font-size: 2rem;
    font-weight: 900;
    line-height: 1.1;
  }

  .stat-card .sub {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .stat-card.cyan .value { color: var(--accent-cyan); }
  .stat-card.gold .value { color: var(--accent-gold); }
  .stat-card.green .value { color: var(--accent-green); }
  .stat-card.red .value { color: var(--accent-red); }
  .stat-card.purple .value { color: var(--accent-purple); }
  .stat-card.orange .value { color: var(--accent-orange); }

  /* Section titles */
  .section-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.3rem;
    color: var(--accent-cyan);
    margin: 36px 0 18px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* Panel */
  .panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px;
    margin-bottom: 20px;
  }

  .panel h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1rem;
    color: var(--accent-gold);
    margin-bottom: 16px;
    letter-spacing: 1px;
  }

  /* Progress bars */
  .progress-item {
    margin-bottom: 14px;
  }

  .progress-item .progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 0.9rem;
  }

  .progress-item .progress-name { color: var(--text-primary); }
  .progress-item .progress-value { color: var(--accent-cyan); font-family: 'JetBrains Mono', monospace; font-weight: 700; }

  .progress-bar {
    height: 8px;
    background: var(--bg-deep);
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 1s ease-out;
    background: var(--gradient-cyan);
  }

  .progress-fill.gold { background: var(--gradient-gold); }
  .progress-fill.green { background: var(--gradient-green); }
  .progress-fill.red { background: var(--gradient-red); }

  /* Deck card */
  .deck-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .deck-card {
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 10px;
    text-align: center;
    transition: all 0.3s;
  }

  .deck-card:hover {
    border-color: var(--accent-gold);
    box-shadow: 0 0 20px #ffd74015;
  }

  .deck-card .card-name {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-primary);
  }

  .deck-card .card-elixir {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    font-weight: 900;
    margin-bottom: 4px;
  }

  .deck-card .card-level {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .deck-card .card-rarity {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
  }

  .rarity-common { background: #b0bec520; color: #b0bec5; }
  .rarity-rare { background: #ff910020; color: #ff9100; }
  .rarity-epic { background: #aa00ff20; color: #aa00ff; }
  .rarity-legendary { background: #ffd60020; color: #ffd600; }
  .rarity-champion { background: #00e5ff20; color: #00e5ff; }

  /* Achievements table */
  .ach-table {
    width: 100%;
    border-collapse: collapse;
  }

  .ach-table td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 0.88rem;
  }

  .ach-table .stars { font-size: 1rem; }

  /* Chart canvases */
  .chart-container {
    position: relative;
    width: 100%;
    height: 350px;
  }

  /* Tier badge */
  .tier-badge {
    display: inline-block;
    font-family: 'Orbitron', sans-serif;
    font-size: 1.6rem;
    font-weight: 900;
    padding: 12px 32px;
    border-radius: 12px;
    border: 2px solid;
    text-align: center;
    margin: 16px auto;
    letter-spacing: 2px;
  }

  .rating-number {
    font-family: 'Orbitron', sans-serif;
    font-size: 4rem;
    font-weight: 900;
    text-align: center;
    margin: 16px 0;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg-deep); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

  /* Animations */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
  .delay-1 { animation-delay: 0.1s; }
  .delay-2 { animation-delay: 0.2s; }
  .delay-3 { animation-delay: 0.3s; }
  .delay-4 { animation-delay: 0.4s; }

  /* Badge list */
  .badge-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .badge-item {
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 0.82rem;
    color: var(--text-secondary);
  }

  .badge-item .badge-icon { margin-right: 4px; }
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1 id="playerName">CLASH ROYALE</h1>
    <div class="subtitle">Player Analytics Dashboard</div>
    <div class="player-tag" id="playerTag"></div>
  </div>

  <!-- Data Input -->
  <div class="input-section" id="inputSection">
    <h2>üìã Paste Your API Data</h2>
    <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.95rem;">
      In your Python notebook, run: <code style="background:#0f1923;padding:3px 8px;border-radius:4px;color:#00e5ff;">import json; print(json.dumps(data))</code> then paste the output below:
    </p>
    <textarea id="dataInput" placeholder='{"tag":"#ABC123","name":"YourName","trophies":6000,...}'></textarea>
    <br>
    <button class="btn" onclick="loadData()">üîç ANALYZE</button>
    <button class="btn btn-secondary" onclick="loadSample()">Load Sample Data</button>
  </div>

  <!-- Dashboard (hidden until data loaded) -->
  <div class="dashboard" id="dashboard">

    <!-- Core Stats -->
    <div class="grid grid-4">
      <div class="stat-card cyan animate delay-1">
        <div class="label">Trophies</div>
        <div class="value" id="trophies">‚Äî</div>
        <div class="sub" id="bestTrophies">Best: ‚Äî</div>
      </div>
      <div class="stat-card green animate delay-2">
        <div class="label">Win Rate</div>
        <div class="value" id="winRate">‚Äî</div>
        <div class="sub" id="winLoss">W/L: ‚Äî</div>
      </div>
      <div class="stat-card gold animate delay-3">
        <div class="label">3-Crown Rate</div>
        <div class="value" id="threeCrownRate">‚Äî</div>
        <div class="sub" id="threeCrowns">3CW: ‚Äî</div>
      </div>
      <div class="stat-card purple animate delay-4">
        <div class="label">King Level</div>
        <div class="value" id="expLevel">‚Äî</div>
        <div class="sub" id="arena">Arena: ‚Äî</div>
      </div>
    </div>

    <div class="grid grid-4">
      <div class="stat-card orange">
        <div class="label">Total Battles</div>
        <div class="value" id="battleCount">‚Äî</div>
      </div>
      <div class="stat-card cyan">
        <div class="label">Challenge Max Wins</div>
        <div class="value" id="challengeMax">‚Äî</div>
        <div class="sub" id="challengeTier"></div>
      </div>
      <div class="stat-card green">
        <div class="label">Total Donations</div>
        <div class="value" id="totalDonations">‚Äî</div>
        <div class="sub" id="donationRatio"></div>
      </div>
      <div class="stat-card gold">
        <div class="label">War Day Wins</div>
        <div class="value" id="warDayWins">‚Äî</div>
      </div>
    </div>

    <!-- Battle Outcome Chart -->
    <div class="section-title">‚öîÔ∏è Battle Performance</div>
    <div class="grid grid-2">
      <div class="panel">
        <h3>Battle Outcomes</h3>
        <div class="chart-container">
          <canvas id="battlePieChart"></canvas>
        </div>
      </div>
      <div class="panel">
        <h3>Key Metrics Comparison</h3>
        <div class="chart-container">
          <canvas id="metricsBarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Player Rating -->
    <div class="section-title">üèÜ Composite Player Rating</div>
    <div class="grid grid-2">
      <div class="panel" style="text-align:center;">
        <h3>Overall Score</h3>
        <div class="rating-number" id="overallRating" style="color:var(--accent-cyan);">‚Äî</div>
        <div class="tier-badge" id="tierBadge" style="border-color:var(--accent-cyan);color:var(--accent-cyan);">‚Äî</div>
      </div>
      <div class="panel">
        <h3>Rating Breakdown</h3>
        <div id="ratingBars"></div>
      </div>
    </div>

    <!-- Radar Chart -->
    <div class="grid grid-2">
      <div class="panel">
        <h3>Player Profile Radar</h3>
        <div class="chart-container" style="height:400px;">
          <canvas id="radarChart"></canvas>
        </div>
      </div>
      <div class="panel">
        <h3>Trophy Milestones</h3>
        <div class="chart-container">
          <canvas id="trophyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Current Deck -->
    <div class="section-title">üÉè Current Deck</div>
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;">Deck Cards</h3>
        <div id="avgElixir" style="font-family:'JetBrains Mono',monospace;color:var(--accent-gold);font-size:1.1rem;"></div>
      </div>
      <div class="deck-grid" id="deckGrid"></div>
    </div>

    <!-- Card Collection -->
    <div class="section-title">üì¶ Card Collection</div>
    <div class="grid grid-2">
      <div class="panel">
        <h3>Card Level Distribution</h3>
        <div class="chart-container">
          <canvas id="cardLevelChart"></canvas>
        </div>
      </div>
      <div class="panel">
        <h3>Cards by Rarity</h3>
        <div class="chart-container">
          <canvas id="rarityChart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid grid-4">
      <div class="stat-card cyan">
        <div class="label">Total Cards</div>
        <div class="value" id="totalCards">‚Äî</div>
      </div>
      <div class="stat-card green">
        <div class="label">Maxed Cards</div>
        <div class="value" id="maxedCards">‚Äî</div>
      </div>
      <div class="stat-card gold">
        <div class="label">Max Rate</div>
        <div class="value" id="maxRate">‚Äî</div>
      </div>
      <div class="stat-card purple">
        <div class="label">Avg Level %</div>
        <div class="value" id="avgLevelPct">‚Äî</div>
      </div>
    </div>

    <!-- Achievements -->
    <div class="section-title">üéñÔ∏è Achievements</div>
    <div class="panel">
      <div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;">
        <div><span style="color:var(--text-secondary);">Total:</span> <span id="achTotal" style="color:var(--accent-cyan);font-weight:700;"></span></div>
        <div><span style="color:var(--text-secondary);">Completed:</span> <span id="achCompleted" style="color:var(--accent-green);font-weight:700;"></span></div>
        <div><span style="color:var(--text-secondary);">Stars:</span> <span id="achStars" style="color:var(--accent-gold);font-weight:700;"></span></div>
      </div>
      <div id="achievementsList"></div>
    </div>

    <!-- Badges -->
    <div class="section-title">üèÖ Badges</div>
    <div class="panel">
      <div class="badge-list" id="badgesList"></div>
    </div>

    <!-- Clan Info -->
    <div class="section-title">üõ°Ô∏è Clan & Social</div>
    <div class="grid grid-3">
      <div class="stat-card cyan">
        <div class="label">Clan</div>
        <div class="value" id="clanName" style="font-size:1.3rem;">‚Äî</div>
        <div class="sub" id="clanRole"></div>
      </div>
      <div class="stat-card green">
        <div class="label">Donation Ratio</div>
        <div class="value" id="donRatio">‚Äî</div>
        <div class="sub" id="generosity"></div>
      </div>
      <div class="stat-card gold">
        <div class="label">Clan Cards Collected</div>
        <div class="value" id="clanCards">‚Äî</div>
      </div>
    </div>

    <!-- League Stats -->
    <div class="section-title">üìä League & Season Stats</div>
    <div class="panel" id="leaguePanel"></div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
// ============================================================
// Chart.js defaults
// ============================================================
Chart.defaults.color = '#7a8fa6';
Chart.defaults.borderColor = '#1a3048';
Chart.defaults.font.family = "'Rajdhani', sans-serif";

let charts = {};

function fmt(n) {
  if (n === undefined || n === null) return '‚Äî';
  return Number(n).toLocaleString();
}

// ============================================================
// Load Data
// ============================================================
function loadData() {
  const raw = document.getElementById('dataInput').value.trim();
  try {
    const data = JSON.parse(raw);
    renderDashboard(data);
  } catch(e) {
    alert('Invalid JSON! Make sure you paste the full output of json.dumps(data).\n\nError: ' + e.message);
  }
}

function loadSample() {
  const sample = {
    tag: "#SAMPLE123",
    name: "SamplePlayer",
    expLevel: 14,
    trophies: 6243,
    bestTrophies: 7105,
    wins: 4521,
    losses: 3876,
    battleCount: 9012,
    threeCrownWins: 1892,
    challengeCardsWon: 28450,
    challengeMaxWins: 16,
    tournamentCardsWon: 1250,
    tournamentBattleCount: 342,
    role: "coLeader",
    donations: 156,
    donationsReceived: 120,
    totalDonations: 87654,
    clanCardsCollected: 23456,
    warDayWins: 178,
    starPoints: 234500,
    expPoints: 12340,
    totalExpPoints: 523400,
    legacyTrophyRoadHighScore: 6500,
    clan: { tag: "#CLAN123", name: "Elite Warriors" },
    arena: { id: 54000015, name: "Arena 15" },
    leagueStatistics: {
      currentSeason: { trophies: 6243, bestTrophies: 6501 },
      previousSeason: { trophies: 6189, bestTrophies: 6402, id: "2024-11" },
      bestSeason: { trophies: 7105, id: "2024-06" }
    },
    currentDeck: [
      { name: "Hog Rider", level: 14, maxLevel: 14, elixirCost: 4, rarity: "rare" },
      { name: "Musketeer", level: 14, maxLevel: 14, elixirCost: 4, rarity: "rare" },
      { name: "Fireball", level: 14, maxLevel: 14, elixirCost: 4, rarity: "rare" },
      { name: "Ice Spirit", level: 14, maxLevel: 14, elixirCost: 1, rarity: "common" },
      { name: "Skeletons", level: 14, maxLevel: 14, elixirCost: 1, rarity: "common" },
      { name: "Cannon", level: 14, maxLevel: 14, elixirCost: 3, rarity: "common" },
      { name: "Log", level: 14, maxLevel: 14, elixirCost: 2, rarity: "legendary" },
      { name: "Ice Golem", level: 14, maxLevel: 14, elixirCost: 2, rarity: "rare" }
    ],
    cards: Array.from({length: 109}, (_, i) => ({
      name: `Card ${i+1}`,
      level: Math.floor(Math.random() * 6) + 9,
      maxLevel: 14,
      rarity: ['common','common','common','rare','rare','epic','legendary','champion'][Math.floor(Math.random()*8)],
      starLevel: Math.random() > 0.7 ? Math.floor(Math.random()*3)+1 : 0
    })),
    achievements: [
      { name: "Team Player", stars: 3, value: 2500, target: 2500 },
      { name: "Friend in Need", stars: 3, value: 87654, target: 2500 },
      { name: "Clan War Hero", stars: 2, value: 178, target: 200 },
      { name: "Challenge Champion", stars: 3, value: 16, target: 12 },
      { name: "Tournament Victor", stars: 2, value: 750, target: 1000 },
      { name: "Practice Makes Perfect", stars: 3, value: 100, target: 100 },
      { name: "Legendary Collector", stars: 2, value: 35, target: 50 },
      { name: "Three Crown Master", stars: 3, value: 1892, target: 1000 },
      { name: "Philanthropist", stars: 1, value: 10000, target: 100000 },
    ],
    badges: [
      { name: "Classic 12 Wins" },
      { name: "Grand 12 Wins" },
      { name: "CRL Badge", level: 3 },
      { name: "Top 1000 Global" },
      { name: "Ladder Legend", progress: 7, target: 10 },
      { name: "1 Year Badge" },
    ]
  };

  document.getElementById('dataInput').value = JSON.stringify(sample);
  renderDashboard(sample);
}

// ============================================================
// Render Dashboard
// ============================================================
function renderDashboard(data) {
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('dashboard').classList.add('active');

  const wins = data.wins || 0;
  const losses = data.losses || 0;
  const battles = data.battleCount || 0;
  const draws = battles - wins - losses;
  const totalDecided = wins + losses;
  const winRate = totalDecided > 0 ? (wins / totalDecided * 100) : 0;
  const threeCrownRate = wins > 0 ? (data.threeCrownWins / wins * 100) : 0;
  const donRatio = (data.donationsReceived || 0) > 0 ? (data.donations / data.donationsReceived) : 0;

  // Header
  document.getElementById('playerName').textContent = data.name || 'Unknown Player';
  document.getElementById('playerTag').textContent = data.tag || '';

  // Core stats
  document.getElementById('trophies').textContent = fmt(data.trophies);
  document.getElementById('bestTrophies').textContent = `Best: ${fmt(data.bestTrophies)}`;
  document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
  document.getElementById('winLoss').textContent = `${fmt(wins)}W / ${fmt(losses)}L`;
  document.getElementById('threeCrownRate').textContent = threeCrownRate.toFixed(1) + '%';
  document.getElementById('threeCrowns').textContent = `${fmt(data.threeCrownWins)} 3-crowns`;
  document.getElementById('expLevel').textContent = data.expLevel || '‚Äî';
  document.getElementById('arena').textContent = data.arena ? data.arena.name : '‚Äî';
  document.getElementById('battleCount').textContent = fmt(battles);
  document.getElementById('challengeMax').textContent = fmt(data.challengeMaxWins);
  document.getElementById('totalDonations').textContent = fmt(data.totalDonations);
  document.getElementById('warDayWins').textContent = fmt(data.warDayWins);

  // Challenge tier
  const cm = data.challengeMaxWins || 0;
  let cTier = cm >= 20 ? 'üèÜ Grand Champion' : cm >= 15 ? '‚≠ê Elite' : cm >= 12 ? 'üí™ Skilled' : cm >= 9 ? '‚úì Competent' : 'üìà Developing';
  document.getElementById('challengeTier').textContent = cTier;

  // Donation ratio
  document.getElementById('donationRatio').textContent = `Ratio: ${donRatio.toFixed(2)}`;

  // Clan
  document.getElementById('clanName').textContent = data.clan ? data.clan.name : 'No Clan';
  document.getElementById('clanRole').textContent = data.role || '';
  document.getElementById('donRatio').textContent = donRatio.toFixed(2);
  document.getElementById('generosity').textContent = donRatio >= 2 ? 'üíé Very Generous' : donRatio >= 1 ? 'üéÅ Generous' : donRatio >= 0.5 ? '‚öñÔ∏è Balanced' : 'üì• Receiver';
  document.getElementById('clanCards').textContent = fmt(data.clanCardsCollected);

  // ‚îÄ‚îÄ Charts ‚îÄ‚îÄ
  destroyCharts();

  // Battle Pie
  charts.battlePie = new Chart(document.getElementById('battlePieChart'), {
    type: 'doughnut',
    data: {
      labels: ['Wins', 'Losses', 'Draws'],
      datasets: [{
        data: [wins, losses, draws],
        backgroundColor: ['#00e676', '#ff1744', '#ffd740'],
        borderColor: '#0b1622',
        borderWidth: 3,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '55%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 20, font: { size: 14 } } }
      }
    }
  });

  // Metrics Bar
  charts.metricsBar = new Chart(document.getElementById('metricsBarChart'), {
    type: 'bar',
    data: {
      labels: ['Trophies', 'Best', 'Wins', 'Losses', '3CW', 'Challenge Cards', 'Donations', 'War Wins'],
      datasets: [{
        data: [data.trophies, data.bestTrophies, wins, losses, data.threeCrownWins, data.challengeCardsWon, data.totalDonations, data.warDayWins],
        backgroundColor: ['#00e5ff', '#4fc3f7', '#00e676', '#ff1744', '#ffd740', '#ff9100', '#b388ff', '#00bfa5'],
        borderRadius: 6,
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { grid: { color: '#1a304830' }, ticks: { callback: v => v >= 1000 ? (v/1000)+'k' : v } },
        x: { grid: { display: false }, ticks: { font: { size: 11 } } }
      }
    }
  });

  // ‚îÄ‚îÄ Composite Rating ‚îÄ‚îÄ
  const scores = {};
  scores['Win Rate'] = Math.min(100, Math.max(0, (winRate - 40) * 2.5));
  scores['Trophies'] = Math.min(100, (data.trophies || 0) / 90);
  scores['Dominance'] = Math.min(100, threeCrownRate * 2);
  scores['Challenge'] = Math.min(100, (data.challengeMaxWins || 0) * 5);
  
  let avgLvlPct = 0;
  if (data.cards && data.cards.length) {
    const pcts = data.cards.map(c => (c.level / c.maxLevel) * 100);
    avgLvlPct = pcts.reduce((a,b) => a+b, 0) / pcts.length;
  }
  scores['Collection'] = avgLvlPct;
  scores['Activity'] = Math.min(100, battles / 200);
  scores['Generosity'] = Math.min(100, donRatio * 50);

  const overall = Object.values(scores).reduce((a,b)=>a+b,0) / Object.keys(scores).length;

  document.getElementById('overallRating').textContent = overall.toFixed(0);
  
  let tier, tierColor;
  if (overall >= 90) { tier = 'üèÜ LEGENDARY'; tierColor = '#ffd740'; }
  else if (overall >= 75) { tier = 'üíé CHAMPION'; tierColor = '#b388ff'; }
  else if (overall >= 60) { tier = '‚≠ê MASTER'; tierColor = '#00e5ff'; }
  else if (overall >= 45) { tier = 'üîµ CHALLENGER'; tierColor = '#4fc3f7'; }
  else if (overall >= 30) { tier = 'üü¢ KNIGHT'; tierColor = '#00e676'; }
  else { tier = 'üå± SQUIRE'; tierColor = '#66bb6a'; }

  const tierEl = document.getElementById('tierBadge');
  tierEl.textContent = tier;
  tierEl.style.borderColor = tierColor;
  tierEl.style.color = tierColor;
  document.getElementById('overallRating').style.color = tierColor;

  // Rating bars
  const ratingBarsHtml = Object.entries(scores).map(([name, score]) => {
    const color = score >= 75 ? 'green' : score >= 50 ? 'gold' : score >= 25 ? '' : 'red';
    return `
      <div class="progress-item">
        <div class="progress-header">
          <span class="progress-name">${name}</span>
          <span class="progress-value">${score.toFixed(0)}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill ${color}" style="width:${score}%"></div>
        </div>
      </div>`;
  }).join('');
  document.getElementById('ratingBars').innerHTML = ratingBarsHtml;

  // Radar chart
  const radarLabels = Object.keys(scores);
  const radarValues = Object.values(scores);
  charts.radar = new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
      labels: radarLabels,
      datasets: [{
        data: radarValues,
        backgroundColor: 'rgba(0, 229, 255, 0.15)',
        borderColor: '#00e5ff',
        borderWidth: 2,
        pointBackgroundColor: '#00e5ff',
        pointRadius: 5,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        r: {
          min: 0, max: 100,
          ticks: { stepSize: 20, backdropColor: 'transparent', font: { size: 10 } },
          grid: { color: '#1a304850' },
          angleLines: { color: '#1a304850' },
          pointLabels: { font: { size: 13, family: "'Rajdhani', sans-serif" } }
        }
      },
      plugins: { legend: { display: false } }
    }
  });

  // Trophy chart
  const trophyData = { 'Current': data.trophies || 0, 'Best': data.bestTrophies || 0 };
  if (data.legacyTrophyRoadHighScore) trophyData['Legacy'] = data.legacyTrophyRoadHighScore;

  charts.trophy = new Chart(document.getElementById('trophyChart'), {
    type: 'bar',
    data: {
      labels: Object.keys(trophyData),
      datasets: [{
        data: Object.values(trophyData),
        backgroundColor: ['#00e5ff', '#ffd740', '#b388ff'],
        borderRadius: 8,
        borderWidth: 0,
        barThickness: 60,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { grid: { color: '#1a304830' } },
        x: { grid: { display: false } }
      }
    }
  });

  // ‚îÄ‚îÄ Current Deck ‚îÄ‚îÄ
  const deck = data.currentDeck || [];
  if (deck.length) {
    const avgE = deck.reduce((s, c) => s + (c.elixirCost || 0), 0) / deck.length;
    document.getElementById('avgElixir').innerHTML = `‚ö° Avg Elixir: <strong>${avgE.toFixed(1)}</strong>`;

    const elixirColors = { 1: '#4fc3f7', 2: '#00e676', 3: '#ffd740', 4: '#ff9100', 5: '#ff5722', 6: '#e91e63', 7: '#9c27b0', 8: '#6a1b9a', 9: '#4a148c', 10: '#311b92' };

    document.getElementById('deckGrid').innerHTML = deck.map(card => `
      <div class="deck-card">
        <div class="card-name">${card.name}</div>
        <div class="card-elixir" style="color:${elixirColors[card.elixirCost] || '#fff'}">${card.elixirCost || '?'}</div>
        <div class="card-level">Lv.${card.level}/${card.maxLevel}</div>
        <div class="card-rarity rarity-${card.rarity || 'common'}">${card.rarity || '?'}</div>
      </div>
    `).join('');
  }

  // ‚îÄ‚îÄ Card Collection ‚îÄ‚îÄ
  const cards = data.cards || [];
  if (cards.length) {
    const maxed = cards.filter(c => c.level === c.maxLevel).length;
    document.getElementById('totalCards').textContent = cards.length;
    document.getElementById('maxedCards').textContent = maxed;
    document.getElementById('maxRate').textContent = (maxed/cards.length*100).toFixed(1) + '%';
    document.getElementById('avgLevelPct').textContent = avgLvlPct.toFixed(1) + '%';

    // Level distribution
    const levelCounts = {};
    cards.forEach(c => { levelCounts[c.level] = (levelCounts[c.level] || 0) + 1; });
    const levels = Object.keys(levelCounts).sort((a,b) => a-b);

    charts.cardLevel = new Chart(document.getElementById('cardLevelChart'), {
      type: 'bar',
      data: {
        labels: levels.map(l => 'Lv.' + l),
        datasets: [{
          data: levels.map(l => levelCounts[l]),
          backgroundColor: '#00e5ff',
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { grid: { color: '#1a304830' } }, x: { grid: { display: false } } }
      }
    });

    // Rarity
    const rarityCounts = {};
    const rarityColors = { common: '#b0bec5', rare: '#ff9100', epic: '#aa00ff', legendary: '#ffd600', champion: '#00e5ff' };
    cards.forEach(c => { rarityCounts[c.rarity] = (rarityCounts[c.rarity] || 0) + 1; });
    const rarities = Object.keys(rarityCounts);

    charts.rarity = new Chart(document.getElementById('rarityChart'), {
      type: 'doughnut',
      data: {
        labels: rarities.map(r => r.charAt(0).toUpperCase() + r.slice(1)),
        datasets: [{
          data: rarities.map(r => rarityCounts[r]),
          backgroundColor: rarities.map(r => rarityColors[r] || '#888'),
          borderColor: '#0b1622',
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutout: '50%',
        plugins: { legend: { position: 'bottom', labels: { padding: 16 } } }
      }
    });
  }

  // ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ
  const achs = data.achievements || [];
  if (achs.length) {
    const completed = achs.filter(a => a.stars === 3).length;
    const totalStars = achs.reduce((s, a) => s + (a.stars || 0), 0);
    document.getElementById('achTotal').textContent = achs.length;
    document.getElementById('achCompleted').textContent = `${completed} (${(completed/achs.length*100).toFixed(0)}%)`;
    document.getElementById('achStars').textContent = `${totalStars} / ${achs.length * 3}`;

    document.getElementById('achievementsList').innerHTML = achs
      .sort((a, b) => (b.stars || 0) - (a.stars || 0))
      .map(a => {
        const pct = a.target > 0 ? Math.min(100, a.value / a.target * 100) : 0;
        const stars = '‚òÖ'.repeat(a.stars || 0) + '‚òÜ'.repeat(3 - (a.stars || 0));
        const color = pct >= 100 ? 'green' : pct >= 50 ? 'gold' : '';
        return `
          <div class="progress-item">
            <div class="progress-header">
              <span class="progress-name"><span class="stars" style="color:var(--accent-gold);margin-right:8px;">${stars}</span>${a.name}</span>
              <span class="progress-value">${fmt(a.value)} / ${fmt(a.target)}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill ${color}" style="width:${pct}%"></div>
            </div>
          </div>`;
      }).join('');
  }

  // ‚îÄ‚îÄ Badges ‚îÄ‚îÄ
  const badges = data.badges || [];
  document.getElementById('badgesList').innerHTML = badges.map(b => {
    let extra = '';
    if (b.level) extra = ` Lv.${b.level}`;
    if (b.progress !== undefined) extra = ` [${b.progress}/${b.target}]`;
    return `<div class="badge-item"><span class="badge-icon">üèÖ</span>${b.name}${extra}</div>`;
  }).join('');

  // ‚îÄ‚îÄ League Stats ‚îÄ‚îÄ
  const ls = data.leagueStatistics;
  let leagueHtml = '';
  if (ls) {
    for (const [key, label] of [['currentSeason','Current Season'],['previousSeason','Previous Season'],['bestSeason','Best Season']]) {
      const s = ls[key];
      if (s) {
        leagueHtml += `<div style="margin-bottom:12px;"><strong style="color:var(--accent-gold);">${label}</strong>`;
        if (s.id) leagueHtml += ` <span style="color:var(--text-muted);font-size:0.85rem;">(${s.id})</span>`;
        leagueHtml += `<br>Trophies: <span style="color:var(--accent-cyan);font-weight:700;">${fmt(s.trophies)}</span>`;
        if (s.bestTrophies) leagueHtml += ` | Best: <span style="color:var(--accent-gold);font-weight:700;">${fmt(s.bestTrophies)}</span>`;
        leagueHtml += `</div>`;
      }
    }
  }

  // Path of Legends
  for (const [key, label] of [['currentPathOfLegendSeasonResult','Current PoL'],['lastPathOfLegendSeasonResult','Last PoL'],['bestPathOfLegendSeasonResult','Best PoL']]) {
    const pol = data[key];
    if (pol && Object.keys(pol).length) {
      leagueHtml += `<div style="margin-bottom:12px;"><strong style="color:var(--accent-purple);">${label}</strong><br>`;
      for (const [k,v] of Object.entries(pol)) {
        leagueHtml += `${k}: <span style="color:var(--accent-cyan);">${v}</span> &nbsp;`;
      }
      leagueHtml += `</div>`;
    }
  }

  document.getElementById('leaguePanel').innerHTML = leagueHtml || '<p style="color:var(--text-muted);">No league data available</p>';
}

function destroyCharts() {
  Object.values(charts).forEach(c => { if (c) c.destroy(); });
  charts = {};
}
</script>
</body>
</html>
